<!-- L04/public/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Managing Assistants MIT Mark 1</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: #121212;
        color: #ffffff;
      }
      .card {
        background-color: #1e1e1e;
        color: #ffffff;
      }
      .form-control,
      .form-select {
        background-color: #2c2c2c;
        color: #ffffff;
        border: 1px solid #444;
      }
      .form-control::placeholder {
        color: #bbbbbb;
      }
      .btn-primary {
        background-color: #3a6ea5;
        border-color: #3a6ea5;
      }
      .border {
        border-color: #444 !important;
      }
      /* Adjust text colors in the conversation window */
      #response span {
        color: #ffffff;
      }
      #response span.user {
        color: #ffcc00;
      }
      #response span.assistant {
        color: #ffffff;
      }
      #response span.system {
        color: #ff3333;
      }
      #response span.function {
        color: #40e0d0;
      }
    </style>

    <script>
      let state = {
        chatgpt: false,
        assistant_id: "",
        assistant_name: "",
        dir_path: "",
        news_path: "",
        thread_id: "",
        user_message: "",
        run_id: "",
        run_status: "",
        vector_store_id: "",
        tools: [],
        parameters: [],
      };

      async function get_data_from_elements() {
        for (let key in state) {
          if (document.getElementById(key) != null) {
            state[key] = document.getElementById(key).value;
          }
        }
        console.log(`getting data from elements: ${JSON.stringify(state)}`);
      }

      function write_data_to_elements(response) {
        for (let key in response) {
          if (document.getElementById(key) != null) {
            document.getElementById(key).value = response[key];
          }
        }
        console.log(`writing data to elements: ${JSON.stringify(state)}`);
      }

      function write_to_div(route, response) {
        let message = response.message;

        // Ensure message is an array
        if (!Array.isArray(message)) {
          let responseDiv = document.getElementById("response");
          responseDiv.innerHTML = JSON.stringify(message);
          return;
        }

        // Select the target div
        let responseDiv = document.getElementById("response");
        if (!responseDiv) {
          console.error("No div with id 'response' found.");
          return;
        }

        // Clear previous contents
        responseDiv.innerHTML = "";

        // Iterate through each object in the array
        message.forEach((item) => {
          // Create a new span element for each item
          var span = document.createElement("span");

          if ("content" in item) {
            span.textContent = `${item.role.toUpperCase()}: ${item.content}`;
          } else if ("function_call" in item) {
            span.textContent = `Function Call: ${JSON.stringify(item.function_call)}`;
          } else {
            span.textContent = JSON.stringify(item);
          }

          // Assign class based on the role for styling
          if (item.role) {
            span.className = item.role;
          }

          // Append the span to the div
          responseDiv.appendChild(span);
          responseDiv.appendChild(document.createElement("br")); // Add a line break for readability
        });
      }

      async function sendRequest(action) {
        get_data_from_elements();

        let route = action;

        console.log(`sending data: ${JSON.stringify(state)} to ${route}`);
        let response = await fetch(`/${route}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(state),
          mode: "cors",
        });
        let res = await response.json(); // we always get back {message, state}
        console.log(`In UI response: ${JSON.stringify(res)}`);
        await parse_response(route, res);

        return;
      }

      async function parse_response(route, res) {
        console.log(`In UI parse_response ${route} data =: ${JSON.stringify(res.state)}`);
        write_data_to_elements(res.state);
        console.log(`Updated state:: ${JSON.stringify(state)}`);
        write_to_div(route, res);
      }
    </script>
  </head>
  <body>
    <div class="card">
      <div class="card-body">
        <section class="part2">
          <div class="container">
            <div class="row" style="width: 70%">
              <div class="col-sm-4">
                <img
                  alt=""
                  class="resize-image left-side"
                  id="image1"
                  src="bridge.png"
                  width="70"
                  height="50"
                />
              </div>
              <div class="col">
                <h4 class="left-side-text">MIT Agent Function Caller</h4>
              </div>
            </div>
          </div>
        </section>

        <div id="assistant-buttons">
          <div class="row mb-3">
            <div class="col">
              <label for="user_message">Your Message:</label>
              <input
                type="text"
                id="user_message"
                name="user_message"
                value=""
                class="form-control"
                placeholder="Enter your message here..."
              />
            </div>
            <div class="col">
              <button
                class="btn btn-primary mt-4"
                type="submit"
                onclick="sendRequest('api/openai-call')"
              >
                Send Message
              </button>
            </div>
          </div>
        </div>

        <div class="container mt-5">
          <label for="response">Conversation:</label>
          <div
            id="response"
            class="border p-3"
            style="height: 400px; overflow: auto"
          ></div>
        </div>
      </div>
    </div>
  </body>
</html>
